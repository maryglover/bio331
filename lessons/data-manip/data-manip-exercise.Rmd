---
title: "Data manipulation"
output:
  html_document:
    toc: true 
    toc_float: true
    toc_collapsed: true
    toc_depth: 3  
layout: default
---

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy()
```

## R packages

So far, we have worked with functions that are loaded into R or base R functions. However, there is a world of other functions out there. You can create your own functions or use ones that others have made. An *R package* is a group of functions that can be loaded and used in R. Again, any one can make an R package, but R hosts a wide variety of functions that go through certain checks. These packages can be installed and loaded into your own R space for you to use. Most packages are a group of functions for a specific use, for example, DNA sequence analysis, diversity analyses , reading maps, etc. 

We are going to use the `dplyr` package to orgaize and manipulate data in this lesson. 

There are two ways to install a package. 

One, you can go to the packages tab in the lower right hand side of Rstudio, where your files are. Then, click install and find the package your want to install. Keep the checkmark checked for "Install dependencies." Some packages use or *depend* on functions from other packages. This will install all additional packages you need. 

![](images/package-install.png)

This will run the code `install.packages()`. The second way is to simply run the code `install.packages()` in the console, with the name of the package

For example, let's say I want the `RColorBrewer` package. This packages adds different colors and palettes that you can use in R. To install the package, I would run:

```
install.packages("RColorBrewer")
```

Now, whenever I want to use functions from this package they are installed in by R library. **You only ever have to install a package once.**

Once, you have installed a package, it is there on your computer. But R doesn't "load" packages unless you tell it to. You can do this by using the `library()` function.

```{r}
library(RColorBrewer)
```

Now you can use the functions in `RColorBrewer`. 

RColorBrewer has may different color palettes. Here, I want to look at a combination of 3 colors in the Set2 palette. 

```{r}
display.brewer.pal(n = 3, name = 'Set2')
```

**Every time you open R, you do have to load the packages you want to use using the `library()` function.**

```{r, echo=FALSE, warning = FALSE}
library(dplyr)
```

## Using dplyr

We are going to use package `dplyr` for managing and manipulating data. This is a widely used package for manipulating and summarizing data. 

This package has already been installed for you in the Learning R project. 

<span style="color:blue">**To use `dplyr`, you will need to load in the package. Go ahead and do that now, based on what you just learned!**</span>

### Climate analysis

To highlight the basic features of `dplyr`, we will continue with the climate data from Raleigh. This data is from the PRISM Climate Group [^1] is a part of Oregon State University and creates datasets using weather stations across the United States. The data sets include total precipitation, maximum temperature, minimum temperature, mean temperature, dew point temperature, vapor pressure deficit, and measurements of global shortwave solar radiation.

The data we are working with is for Raleigh, NC and includes minimum temperature, maximum temperature, mean temperature and precipitation for each month from 1981 to 2023.

First, we will import that data. Again, this data is in the data directory in your Learning R project. I will assign the data the name `climate`.

```{r}
climate <- read.csv("data/raleigh_prism_climate.csv")
head(climate)
```

### Pipes
As you can see, when you load the data, it is too large to show the entire data set in the R console, so the function `head` can be useful to show just the first 10 rows. One very useful tool in R which is utilized well in `dplyr` is the use of "pipes". Pipes allow you to "pipe" data into a function. This is very helpful when running many functions on a dataset. 

The pipe syntax is `|>`. You may also see `%>%` which is an older version. The pipe takes the output of the previous code and uses it as the first argument in the next function. In `dplyr`, as with many functions, the first argument is the data. 

For example, 

```{r}
climate |> head()
```

A much easier way to read the pipe is by putting functions on different lines. 

```{r}
climate |>
  head()
```

### Filter
To explore the data a bit, we can use `dplyr` functions `filter` and `select` to view only certain rows or columns. 

The `filter` function takes arguments for data and the criteria for filtering the data based on a specific column. For example, you could "filter" the data to show only rows where the year is 2023 in the climate data with the argument `year == 2023`. Here, because the year is a number you do not need quotations. If you are sorting by a character, you would need quotations marks (ex. city == "Raleigh"). 

```{r, warning=FALSE}
filter(climate, year == 2023)
```

To use the pipe, you could also do the following

```{r}
climate |>
  filter(year == 2023)
```

*Important syntax*

- == : equals
- \> : greater than
- < : less than
- != : not equal to 
- \>= : greater than or equal to 
- <= : less than or equal to 
- | : or
- %in% : matches contents of a vector

You can also filter by multiple criteria. Let's say you want only January of months before 2020. 

```{r}
climate |>
  filter(year < 2020, month == 1) 
```

You can also use the "|" sign for "or".

```{r}
climate |>
  filter(year == 2023 | year == 1985)
```

Lastly, let's say you only want the odd years in the 1990s. You could use `%in%` which will match any "in" a given vector. Remember the `c()` can make a vector.

```{r}
climate |>
  filter(year %in% c(1991, 1993, 1995, 1997, 1999 ))
```

**NOTE**: Notice in each of the previous examples your data frame `climate` remains unchanged. You have just been viewing the filtered data. If you want to save the filtered data you would have to assign it to a new variable. 

```{r}
climate2023 <- climate |>
  filter(year == 2023)

climate2023
```

<span style="color:blue">**Activity: Filter the data for the year that you were born.**</span>

### Select

`select()` is very similar to filter except it works on columns. 

Let's say you only want to look at the precipitation column and not the temperature ones. 

```{r}
climate |>
  select(year, month, precip) |>
  head()
```

You also can use the minus sign (-) to remove a column. 

```{r}
climate |>
  select(-precip) |>
  head()

```

Another useful tip is that you can even rename columns by using the equal sign with a new name.  

```{r}
climate |>
  select(year, month, precipitation = precip ) |>
  head()

```

Lastly, you can also chain the filter and select functions again using the pipe. Here, we will look only at maximum temperature for January

```{r}
climate |>
  filter(month == 1) |>
  select(year, tmax)
```

<span style="color:blue">**Activity: Filter the data for the year AND month that you were born. Select only the mean temperature column to display**</span>

## Tidy Data

So far, you have been working with already "clean" tidy data. There are no mistakes in the data, including typos and the data is already in a tidy format. This is not always the case, either due to mistakes in entering your own data or the format of open source data. There are many functions in `dplyr` to edit data frames, including some that will change to format of rows and columns to make them in tidy format. 

We will not go into functions to edit the structure of the data frame but there are a few useful functions to edit the cells or columns in your data frame. 

How data are organized in a data table is an important part of analyzing data. Keeping your data organized in a consistent and standard way will help you explore the data and use functions in R that expect data to be in a specific format.

We will be working with "*tidy*" data. Tidy data is set up such that:
- Every column is a variable
- Every row is an observation 
- Every cell is a value. 

![](images/tidy-data.png)


For example:

![](images/tidy-example.png)

<span style="color:blue">**Airplane activity**: Is your data tidy? Go back to your google sheets entry and make it tidy!</span>

## Additional functions

Here are some other functions that can be useful when exploring the data in different columns. For each of these functions, you must specify the *column* you want to work with.

- `distinct()`: show only the unique value
- `arrange()` : sort the data by a specific column


You can also use other base r functions that we have used before. For example,

- `max()`
- `min()`
- `mean()`
- `median()`

### Distinct

Distinct is a helpful function for viewing what unique characters are in your data set. Let's see what different years are in the climate data

```{r}
climate |>
  distinct(year)
```

### Arrange

`arrange()` is very useful for sorting data by a specific column. 

Let's say we want to sort based on the mean temperature. 

```{r}
climate |>
  arrange(tmean) |>
  head()
```

Here, you can see that it is sorting the mean temperature from least to greatest. We can see that December 1989 had the lowest mean temperature of 0.96 degrees C. 

If we want to sort from greatest to least, we can specify, that we want in descending order using `desc()`

```{r}
climate |>
  arrange(desc(tmean)) |>
  head()
```

Now, we can see that July 2012 had the highest mean temperature. 

Alternatively, we can use the minus sign "-" to show that we want in descending order. 

```{r}
climate |>
  arrange(-tmean) |>
  head()
```

<span style="color:blue">**Activity: What month had the highest precipitation?**</span>

### Mutate

In dplyr, you can make new columns based on existing columns using the `mutate()` function. The `mutate()` function expects the format new_column = how to modify. This can be very useful for determining rates, proportions, etc. 

For example, you could get the difference in maximum temperature and minimum temperate by doing the following:

```{r}
climate |>
  mutate(temp_difference = tmax - tmin) |>
  arrange(temp_difference) |>
  head()
```

<span style="color:blue">**Activity** : In the climate data the mean temperature (tmean) is calculated by the Prism data group as the average of the minimum and maximum temperature. Can you use `mutate()` to calculate this variable and compare to the column calculated by Prism. </span>

## Water quality activity

In this course, we will exploring historic water quality data from the City of Raleigh. The data is collected from 2008 - 2023 and includes 19 different water quality variables, including water temperature, *E. coli* bacteria, and dissolved oxygen for 18 different stream sites. 

You can read the data into R. The file "raleigh_wq_2008_2023.csv" is in your data folder. 

```{r}
wq <- read.csv('data/raleigh_wq_2008_2023.csv')
```

<span style="color:blue">**Activity**: Review the data. Is it tidy?</span>

### Quality control of data

When working data, it is important to check the data to make sure there are no errors or issues in the data. For example, are there typos? numbers that don't make sense? 

Let's take a look at the water quality data to check to see if there are any issues. 

First, take a look at the first few rows, using the function `head()`

```{r}
head(wq)
```

What do you notice already?

Now, let's look at a tidy version so that we can use some of the `dplyr` functions we just learned. Here, I am giving you a copy of the water quality data that I have put into a "tidy" format. 

To read in the data, run the following code.

```{r}
wq_tidy <- read.csv('https://maryglover.github.io/bio331/water_quality_manip/raleigh_wq_tidy.csv')
```

1. First take a look at what columns are in the dataset using the `colnames()` function
1. Take a look at the first few rows to see what the data look like using `head()`
1. Use the `distinct()` function to see what locations or "Sites" were evaluated in Raleigh. 

<span style="color:blue">**What do you notice about the data?**</span>

Now you can take a look at the data that has been cleaned up!

Use the following code to download the csv. 

```{r}
wq_tidy <- read.csv('https://maryglover.github.io/bio331/water_quality_manip/raleigh_wq_clean.csv')
```

## Homework Exercise

**Complete the rest of the exercises in an R script.** Use comments to separate questions and describe what your code is doing. When you complete the exercises, submit the R script (.R file) in Moodle. 

For homework, you will answer questions on a dataset with data from imdb movie data. 

### Set up 
1. Read into R the dataset named "movies.csv" in your data folder. Assign it the name `movies`.
2. Run the following code so that you can analyze the data. You don't need to do anything else for this questions :)

```
movies <- movies |>
mutate(budget = as.numeric(budget), intgross = as.numeric(budget))
```

### Analyzing the data

3. There are a lot of columns in this data set, review the columns using the code `colnames(movies)`
4. Use `select` to only show the following columns. Resave the data with only the selected columns by assigning it a new name. Select columns
- year
- title
- budget
- intgross
- rated
- metascore
- imdb_rating

5. Filter the data for movies that were released in your birth year. How many movies are there from that year? (Hint: use a comment in your code to give your answer). 
5. Use the `arrange()` function to determine what 3 movies had the highest budget.  
5. Use the `arrange()` function to determine the G rated movie with the highest imdb metascore. (Hint: you will have to filter first!)
5. Determine the profit of the movies by subtracting the budget from the international gross (`intgross`), using the `mutate()` function. (hint, you will have to have a name for your new profit column). 
7. What movie had the highest profit? 
8. What movie had the highest profit in 1990?
6. *Reach*: What year had the highest *average* imdb meta score (1980, 1990, or 2000). Hint: you will have to do each year separately and use the `mean` function to get the average. 

## List of new functions
- `filter()`
- `select()`
- `distinct()`
- `nrows()`
- `arrange()`
- `mutate()`

*You can always use the "?" before a function to pull up the help page of a function, which also has examples.* For example `?mutate`

## Resources

There are loads of resources out there for dplyr, including simply googling what you want to do. Here are a few: 

- [R for Data Science book](https://r4ds.hadley.nz/). See data transformation and data tidying sections
- [Stat 454 Intro to dplyr](https://stat545.com/dplyr-intro.html)
- [Data school dplyr tutorial](https://www.dataschool.io/dplyr-tutorial-for-faster-data-manipulation-in-r/)

[^1]: PRISM Climate Group, Oregon State University, <https://prism.oregonstate.edu>, accessed 17 Jan 2024.