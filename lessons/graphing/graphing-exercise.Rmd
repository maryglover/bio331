---
title: "Data visualization"
output:
  html_document:
    toc: true 
    toc_float: true
    toc_collapsed: true
    toc_depth: 3  
layout: default
---

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy()
```

## Introduction to ggplot

In this lesson, you will learn how to plot graphs or figures in R. When working with data, it is good practice to plot the data to evaluate it. This can help identify trends or even problems in the data. Also need plotting for displaying and communicating results. There are basic plotting functions in R, but we will use the functions in the package `ggplot2`. 

We will use the package `ggplot2` to produce visualizations in this class:

- ggplot works well with the "tidy" data and data manipulations that you did in the previous lesson with `dplyr`
- ggplot is very customizable, allowing you to alter titles, colors, style, etc. with R code. 
- ggplot produces pretty graphs. 

### Install `ggplot2` 

To use `ggplot2`, you must first install it. You can use the packages tab on the lower right hand pane of Rstudio or with the code:

```
install.packages('ggplot2')
```

You only have to install the `ggplot2` package once, but don't forget to load it in *each* time you want to use it. 

```{r}
library(ggplot2)
```

### Getting the data ready

In this lesson, let's start with the movie data that you used in the homework of the `dplyr` [lesson](https://maryglover.github.io/bio331/lessons/data-manip/data-manip-exercise.html#Homework_Exercise). Making graphs is a great way to explore the data. 

Go ahead and load in the data and also run the code from the lesson to make the data numeric. 

```{r, warning = FALSE}
movies <- read.csv('data/movies.csv')

library(dplyr)
movies <- movies |>
  mutate(budget = as.numeric(budget), 
         intgross = as.numeric(budget),
         rated = as.factor(rated))
```

We will also simply the data by selecting only some of the columns and reassigning it the name `movies_select`

```{r}
movies_select <- movies |>
  select(year, title, budget, intgross, rated, metascore, imdb_rating)
```
  
## Layers

`ggplot2` uses what are called "layers" to plot data. These layers are added on one another to produce the visualization. 

The first layer sets the *foundation* and uses the function `ggplot()`. The `ggplot()` function expects:

1. the data you are plotting
2. the aesthetic mapping `aes()`. This provides the columns that will be displayed on the graph. For example, the what column is the x axis and which is the y axis.

Let's say that we wanted to plot a histogram of the number of of the movies released in each year. A histogram shows the distribution of values, with the value on the x axis. In this case, our x axis will be the year and the number of times is found in the data on the y axis. To do this, we will set the aesthetic for the x axis as the `year` column. 

```{r new plot}
ggplot(data = movies_select, aes(x = year))
```

You will notice that this plots an empty graph. This code sets up the foundation of the plot, including the "coordinate system" or scale of the axes. To add the data, you must *add* an additional layer. To plot the precipitation as a histogram, we will add the `geom_histogram()` function to the foundation. Because you have already stated the data and the axes, you do not need to provide additional arguments. 

```{r precip-hist}
ggplot(data = movies, aes(x = year)) +
  geom_histogram()
```

***What do you notice about the movie release date data?***

<span style="color:blue">**Activity**: Make a histogram using the different movie metascrore. </span>

```{r, echo=FALSE, warning=FALSE}
ggplot(data = movies_select, aes(x = metascore)) +
  geom_histogram()
```

To create different types of plots, you would use a different layer. Some examples are:

- `geom_point`: plots points for a scatterplot
- `geom_bar`: barplot
- `geom_boxplot`: boxplot
- `geom_line`: line graph. 

For most graphs, you would need to specify both the x and y axis in the aesthetics `aes()`. For example, lets say that you wanted to see the budget of movies over the years. Here, we would have `year` on the x axis and `budget` on the y axis. You could do this with points for every data point with `geom_point`.

```{r}
ggplot(data = movies_select, aes(x = rated, y = budget)) +
  geom_point()
```

You could also graph this data with a boxplot, which might make more sense here. A boxplot is a way to show the distribution of data, by displaying the summary statistics, including the median, the 25% and 75% quantiles, and outliers. Here, you need to specify the "group" in the boxplot aesthetic to show what goes into each box should be a separate box. 

```{r}
ggplot(data = movies_select, aes(x = rated, y = budget)) +
  geom_boxplot(aes(group=rated))
```


You can see that some of these boxes, you probably don't care about. You can combine your `dplyr` functions with `ggplot`. Let's only look at ratings of G, PG, PG-13, and R. Here, we will resave the data into the `movies_select` object. 

```{r}
movies_select <- movies_select |>
  filter(rated %in% c('G', 'PG', 'PG-13', 'R'))
```

Now, let's look at the boxplot. 

```{r}
ggplot(data = movies_select, aes(x = rated, y = budget)) +
  geom_boxplot(aes(group = rated))
```

<span style="color:blue">**Activity**: Make another boxplot, but this time look at the metascore for each movie rating. </span>

### Facets

The last type of plot we will discuss are facets. Facets allow you to compare variables by plotting different plots side by side. The `facet_wrap` layer subsets the data based on a variable. 

Let's say we want to see how the budget impacts the metascore. Maybe we want to know if movies that cost more money get better ratings. 

Try to set up this scatter plot on your own. It should look like this:

```{r, echo = FALSE}
ggplot(movies_select, aes(x = budget, y = metascore)) +
  geom_point()
```

Now, let's say we want to look at each of the different ratings separately. We can use a "facet" to do this. We will "add" on the `facet_wrap` layer

```{r}
ggplot(movies_select, aes(x = budget, y = metascore)) +
  geom_point()+
  facet_wrap(~rated)
```

**What do you notice about the data?**

## Water quality data

Let's now go back to our City of Raleigh water quality data and use plots to explore the data. 

First, we need to read in the data into R again. 

```{r}
wq_clean <- read.csv('https://maryglover.github.io/bio331/water_quality_manip/raleigh_wq_clean.csv')
```

**Activity: **First, pick one of the different parameters and make a histogram. Record the code in your script and make a note about what you see. 

Now, let's use the data to explore the relationship of temperature and dissolved oxygen (in percent saturation). What do you predict?

```{r}
ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point()
```  

Now, let's see what we notice about the different sites. We can start with exploring the amount of phosphorus at each site using a boxplot.

```{r}
ggplot(data = wq_clean, aes(x = Site, y = Phosphorus_total_mg_L )) +
  geom_boxplot()
```

You can see that there are duplicate sites! This is part of the City of Raleigh's quality control. In some cases, they will collect duplicates as a way to make sure they are getting accurate results. 

Run the following code to remove the duplicates. You don't need to understand what this code is doing for assessments, but it will filter out any site with the "DUP" or "Dup" in them. 

```{r}
wq_clean<- wq_clean |>
  filter(!grepl("DUP",Site)) |> # gets rid of duplicate sites
  filter(!grepl("Dup",Site))
```

Now, rerun the boxplot code. 

```{r}
ggplot(data = wq_clean, aes(x = Site, y = Phosphorus_total_mg_L )) +
  geom_boxplot()
```

Now, look at the amount of E. coli in MPN units. What do you notice?

```{r}
ggplot(data = wq_clean, aes(x = Site, y = E_coli_MPN_100mL )) +
  geom_boxplot()
```

Here, you can see that there is an outlier! Use `dplyr` functions to sort the *E. coli* data to look more closely. 

This is an example of a time where good scientific judgement is needed to figure out what to do with this data point. It is *not* appropriate to remove a data point just because it is very different from another. However, there are times when an outlier is due to an error in data collection or recording. It is important to understand the parameter to determine what is going on. This is more complicated when we did not collect the data. In this instance, I was able to talk to the data collector and they indicated that this value for *E. coli * is not a reasonable value and is likely due to a lab issue. In this case, we can remove this data point. 

Run the following code to do that. 

```{r}
wq_clean <- wq_clean |>
 mutate(E_coli_MPN_100mL = gsub('155310', NA, E_coli_MPN_100mL))
```

Because we have made some changes in the water quality data, it is a good idea to save the data set. We can do this with the `write.csv()` function. We *should not* rewrite the orignial data file, but should rename it. Here, we provide the arguments for the data frame we want to save, and the name of the file. 

```{r, eval=FALSE}
write.csv(wq_clean, 'data/wq_clean2.csv', row_names = FALSE)
```

## Customizing plots

So far, the plots have just been using the default display settings. In ggplot, you can customize the appearance of the plots using addition code or layers. 

### Labels

First, we will use additional layers to add labels, including axis labels and titles. To change the axis labels, we can use the `labs()` layer. In `labs` you can specifiy changing the x-axis (x), y axis (y), and the title.

For example, let's go back to our temperature and dissolved oxygen plot. We will "add" the `labs()` layer to change the x and y axis labels

```{r}
ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point()+
  labs(x = "Temperature (C)", y = "Dissolved Oxygen (% sat)") 
```

You can also add a title with "title = ". 
```{r}
ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point()+
  labs(x = "Temperature (C)", y = "Dissolved Oxygen (% sat)", title = 'Dissolved oxygen decreases with temperature') 
```

### Theme

The default in ggplot is to use have the background as gray with white gridlines. There are layers to edit the background and gridlines. But the easiest way to change the overall look of the plot is to change the "theme" of the plot. There are several different themes that can be "added" to a plot. We will use one called `theme_minimal`.  To see a full list, see the help file for the themes type `?theme_minimal`

```{r}
ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point()+
  labs(x = "Temperature (C)", y = "Dissolved Oxygen (% sat)", title = 'Dissolved oxygen decreases with temperature')  +
  theme_minimal()
```

**Exercise**: Play around with the different themes to find one you like. 

### Color

You can also change the color in ggplot using the 'color' or 'fill' argument. Color is used to change the color of the outline, and fill is used to color the inside of a shape. For geom_point(), you would change the color. 

```{r}
ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point(color = 'blue')
```

Let's say you are plotting a boxplot. You could change the outline and fill of the boxes. Here again, is a boxplot for phosphorus for each site.

```{r}
ggplot(data = wq_clean, aes(x = Site, y = Phosphorus_total_mg_L )) +
  geom_boxplot(color = 'darkblue', fill = 'lightblue')
```

To see a full list of colors you can use, see [R color chart](RColorChart.pdf). 

### Other customizations

In the layers, you can also change other aspects including

- size: `size = `
- shape of points: `shape = ` 
- line type (ex. dashed, solid): `linetype = `

For a list of the aesthetics, see <https://ggplot2.tidyverse.org/articles/ggplot2-specs.html>

### Color Aesthetics

So far we have changed the color of all the data. However, a very useful way to use color is to base the color on a different variable, or column in the data. 

To color based on a variable, we need to add color in the aesthetic mapping or `aes()`, to say that color should be based on the year column. Here, we will go back to our temperature and DO graph. We can color each of the points based on the stream or "Site". We have to indicate in `aes()` that we want the color to be based on the Site column. 

```{r}
ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point(aes(color = Site))
```

## Saving plots

In this lesson, all of the plots are shown in R but not saved anywhere. Plotting data is a great way to understand the data and explore patterns. When you are ready to communicate your results with a figure, you can save the plot with the `ggsave` function. 

Here, we can save the boxplot for temperature and DO and save to our computer. First, we will assign the plot a name and then save with `ggsave`

```{r}
temp_boxplot<-ggplot(wq_clean, aes(x = Temperature_C, do_percent_sat)) +
  geom_point()+
  labs(x = "Temperature (C)", y = "Dissolved Oxygen (% sat)", title = 'Dissolved oxygen decreases with temperature') +
  theme_bw()
```

`ggsave` needs arguments for the file name your the file you are saving and the plot to save. For the file name, you must give an extension. This will determine what type of file it is saved as. For example, you can save as png, pdf, jpeg, etc.

```{r, eval=FALSE}
ggsave(filename = "do_temp.png", temp_boxplot)
```

### Water quality data graphs

Play around some more with the water quality data and make a few more graphs to explore the data. 

## Exercises

For homework, continue working with the Raleigh climate data from the `dplyr` [lesson](https://maryglover.github.io/bio331/lessons/data-manip/data-manip-exercise.html). 

1. Read in the climate data set. It is in your data folder as "raleigh_prism_climate.csv"
```{r, echo = F, warning=F}
climate <- read.csv('data/raleigh_prism_climate.csv')
```
1. Make a histogram of the precipitation data. 
```{r, echo = F, message=FALSE, fig.show='hide'}
ggplot(data = climate, aes(x = precip)) +
  geom_histogram()
```
1. What do you notice about the precipitation data? Write your answer as a comment in your R script. 
1. Filter the data set to only include data from your birth year. Assign the data a new name
```{r, echo = F, warning=F}
climate1990 <- climate |>
  filter(year == 1990)
```
1. Make a scatter plot using the data you just made with your birth year. Again, plot the mean temperature data by the month data. 
```{r, echo = F, warning=F, fig.show='hide'}
ggplot(data = climate1990, aes(x = month, y = tmean)) +
  geom_point()
```
1. Connect the dots from the last plot to make a line graph. To do this, you will add a line plot layer to the previously made graph. The line plot layer is `geom_line()`
```{r, echo = F, warning=F,fig.show='hide'}
ggplot(data = climate1990, aes(x = month, y = tmean)) +
  geom_point()+
  geom_line()
```
1. Create a line graph plot for the maximum temperature (`tmax`) for each year *only* for the month of July. Hint, you will need to filter the data for the month of July first, then make the line graph. 
2. Do you notice a pattern? Comment your answer in the script. 
3. Using the same graph of July temperature, change the color of the line. 
3. Using the same graph, change the *theme* of the graph. 
4. Using the same graph, add a title to the graph. 
```{r, echo = F, warning=F,fig.show='hide'}
climateJuly<- climate |>
  filter(month == 7)
ggplot(data = climateJuly, aes(x = year, y = tmax))+
  geom_line(color = 'slateblue')+
  labs(title = 'July maximum temperature over time')+
  theme_bw()
```

## New functions

- `ggplot()`
- `geom_*()`
- `labs()`
- `facet_wrap()`
- `theme_*()`
- `ggsave()`

## Resources

- [R for Data Science intro](https://r4ds.hadley.nz/data-visualize)
- [R for Data Science advanced](https://r4ds.hadley.nz/layers)
- [R graph gallery](https://r-graph-gallery.com/boxplot.html) This has many examples with code.
[Graphing with ggplot2 lesson](https://sesync-ci.github.io/graphics-with-ggplot2-lesson)